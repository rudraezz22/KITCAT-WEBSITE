<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KitCat Bot | AI Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');

        /* --- THEME ENGINE --- */
        :root {
            --bg-from: #fdf2ff;
            --bg-via: #e5d9ff;
            --bg-to: #cffafe;
            --accent: #fb7185;
            --accent-soft: rgba(251, 113, 133, 0.15);
            --accent-strong: rgba(251, 113, 133, 0.5);
        }

        [data-theme="cyber"] {
            --bg-from: #0d0221;
            --bg-via: #1a0033;
            --bg-to: #0d0221;
            --accent: #22d3ee;
            --accent-soft: rgba(34, 211, 238, 0.12);
            --accent-strong: rgba(34, 211, 238, 0.45);
        }

        [data-theme="rose"] {
            --bg-from: #fff1f2;
            --bg-via: #fecdd3;
            --bg-to: #fee2e2;
            --accent: #fb7185;
            --accent-soft: rgba(248, 113, 113, 0.18);
            --accent-strong: rgba(248, 113, 113, 0.55);
        }

        [data-theme="dark"] {
            --bg-from: #000000;
            --bg-via: #0a0a0a;
            --bg-to: #000000;
            --accent: #e0e0e0;
            --accent-soft: rgba(224, 224, 224, 0.12);
            --accent-strong: rgba(224, 224, 224, 0.4);
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background: radial-gradient(circle at top, var(--bg-from), var(--bg-via), var(--bg-to));
            transition: background 0.8s ease;
            min-height: 100vh;
        }

        .scrollbar-custom::-webkit-scrollbar { width: 4px; }
        .scrollbar-custom::-webkit-scrollbar-thumb { background: rgba(15, 23, 42, 0.2); border-radius: 10px; }
        
        .scanline {
            width: 100%; height: 2px; background: rgba(148, 163, 184, 0.15);
            position: absolute; top: 0; z-index: 5; animation: scan 6s linear infinite;
        }
        @keyframes scan { from { top: 0; } to { top: 100%; } }
        
        .user-msg {
            background: var(--accent-soft);
            border: 1px solid var(--accent-strong);
        }

        .kitcat-card {
            box-shadow:
                0 18px 45px rgba(15, 23, 42, 0.35),
                0 0 0 1px rgba(148, 163, 184, 0.15);
        }

        .floating-pill {
            backdrop-filter: blur(18px);
            background: rgba(255, 255, 255, 0.7);
        }
    </style>
</head>

<body class="text-slate-800">

    <div id="theme-panel" class="hidden fixed top-20 left-20 z-50 bg-slate-900/90 border border-white/10 p-4 rounded-2xl backdrop-blur-xl shadow-2xl flex flex-col gap-2">
        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-2 px-4">Theme Mood</p>
        <button onclick="setTheme('default')" class="flex items-center gap-3 px-4 py-2 hover:bg-white/5 rounded-lg transition text-rose-300 text-sm">
            <span class="w-3 h-3 rounded-full bg-rose-400"></span> Soft Candy
        </button>
        <button onclick="setTheme('cyber')" class="flex items-center gap-3 px-4 py-2 hover:bg-white/5 rounded-lg transition text-cyan-300 text-sm">
            <span class="w-3 h-3 rounded-full bg-cyan-400"></span> Cyber Glow
        </button>
        <button onclick="setTheme('rose')" class="flex items-center gap-3 px-4 py-2 hover:bg-white/5 rounded-lg transition text-pink-300 text-sm">
            <span class="w-3 h-3 rounded-full bg-pink-400"></span> Lover Mode
        </button>
        <button onclick="setTheme('dark')" class="flex items-center gap-3 px-4 py-2 hover:bg-white/5 rounded-lg transition text-slate-300 text-sm">
            <span class="w-3 h-3 rounded-full bg-slate-500"></span> Midnight
        </button>
    </div>

    <div class="min-h-screen flex">
        <div class="hidden lg:flex w-20 border-r border-white/20 flex-col items-center py-6 gap-6 bg-white/40 backdrop-blur-xl rounded-r-[2rem] ml-4 mt-6 mb-6">
            <div class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-rose-400 via-purple-400 to-sky-400 flex items-center justify-center shadow-lg shadow-rose-300/60">
                <i data-lucide="sparkles" class="text-white w-5"></i>
            </div>
            
            <i data-lucide="brain" class="text-slate-500 hover:text-purple-500 cursor-pointer transition"></i>
            <i data-lucide="heart" class="text-pink-400 hover:text-rose-500 cursor-pointer transition"></i>
            
            <button onclick="toggleThemePanel()" data-theme-toggle class="mt-auto mb-4 group text-center">
                <i data-lucide="palette" class="text-slate-500 group-hover:text-rose-400 transition"></i>
                <span class="block text-[8px] text-slate-500 mt-1 uppercase tracking-[0.2em]">Themes</span>
            </button>
        </div>

        <div class="flex-1 flex flex-col lg:flex-row items-stretch gap-8 px-4 lg:px-12 py-6">
            <!-- Chat Panel (Left on larger screens) -->
            <div class="w-full lg:w-1/2 flex flex-col order-1">
                <header class="mb-4">
                    <p class="text-xs font-semibold text-rose-400 tracking-[0.25em] uppercase mb-1">AI Companion</p>
                    <h1 class="text-3xl lg:text-4xl font-semibold bg-gradient-to-r from-rose-500 via-purple-500 to-sky-500 bg-clip-text text-transparent">
                        KitCat
                    </h1>
                    <p class="text-slate-600 text-sm mt-1">
                        Talk soft. Flirt hard. Think smarter.
                    </p>
                </header>

                <div id="chat-container" class="flex-1 overflow-y-auto space-y-4 pr-1 lg:pr-2 mb-4 scrollbar-custom flex flex-col max-h-[60vh] lg:max-h-none">
                    <div class="bg-white/80 backdrop-blur-md border border-white/80 p-4 rounded-2xl self-start max-w-[90%] text-slate-700 text-sm shadow-sm">
                        Hey, I'm KitCat. I wake up fast, reply faster, and remember just enough to tease you later. What are we talking about today?
                    </div>
                </div>

                <div class="relative group mt-auto">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-rose-300 via-purple-300 to-sky-300 rounded-2xl blur opacity-40 group-focus-within:opacity-70 transition"></div>
                    <div class="relative flex items-center gap-3 bg-white/90 border border-white/80 rounded-2xl p-3">
                        <input 
                            type="text" 
                            id="user-input" 
                            placeholder="Type like youâ€™re texting her..." 
                            class="flex-1 bg-transparent outline-none text-slate-800 placeholder-slate-400 text-sm">
                        <button 
                            onclick="sendMessage()" 
                            class="p-2 bg-gradient-to-tr from-rose-400 via-fuchsia-400 to-sky-400 rounded-xl hover:scale-105 active:scale-95 transition-all shadow-md">
                            <i data-lucide="send" class="text-white w-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- KitCat Visual Card (Right on larger screens) -->
            <div class="w-full lg:w-1/2 flex items-center justify-center mt-6 lg:mt-0 order-2">
                <div class="relative w-full max-w-md">
                    <div class="absolute -top-10 -left-6 floating-pill px-4 py-2 rounded-full shadow-md flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-rose-400 animate-pulse"></span>
                        <span class="text-[10px] font-semibold tracking-[0.2em] text-slate-600">KITCAT ONLINE</span>
                    </div>

                    <div class="absolute -bottom-8 -right-6 floating-pill px-4 py-2 rounded-full shadow-md flex items-center gap-2">
                        <i data-lucide="sparkles" class="w-3 h-3 text-amber-400"></i>
                        <span class="text-[10px] font-medium text-slate-600">AI that flirts & thinks</span>
                    </div>

                    <div class="relative kitcat-card rounded-[2.2rem] overflow-hidden bg-white shadow-2xl border border-white/80 mt-6">
                        <div class="scanline"></div>

                        <div class="absolute top-4 left-4 flex items-center gap-2 bg-white/70 rounded-full px-3 py-1 text-[10px] text-slate-600">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                            LIVE COMPANION
                        </div>

                        <img src="kitcatimg.png" 
                             onerror="this.onerror=null; this.src='https://placehold.co/800x800/fee2f2/f472b6?text=KitCat';" 
                             class="w-full h-full object-cover">

                        <div class="absolute inset-x-0 bottom-0 p-4 bg-gradient-to-t from-black/60 via-black/20 to-transparent text-white">
                            <p class="text-xs uppercase tracking-[0.25em] text-rose-200 mb-1">Rudra's KitCat</p>
                            <p class="text-sm font-medium text-slate-100">Cute, chaotic, and a little too smart for her own good.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
    /* ================= ICON INIT ================= */
lucide.createIcons();

/* ================= DOM ELEMENTS ================= */
const input = document.getElementById('user-input');
const container = document.getElementById('chat-container');
const themePanel = document.getElementById("theme-panel");

/* ================= THEME SYSTEM ================= */

/**
 * Sets the theme and saves it to local storage.
 * Supports both manual selection and server-side triggers.
 */
function setTheme(theme) {
    if (!theme) return;

    if (theme === 'default') {
        document.body.removeAttribute("data-theme");
        localStorage.removeItem("kitcat-theme");
    } else {
        document.body.setAttribute("data-theme", theme);
        localStorage.setItem("kitcat-theme", theme);
    }
    
    // Close panel after selection if it's open
    themePanel.classList.add("hidden");
}

/* Load saved theme on page load */
const savedTheme = localStorage.getItem("kitcat-theme");
if (savedTheme) {
    setTheme(savedTheme);
}

/* Theme panel toggle */
function toggleThemePanel() {
    themePanel.classList.toggle("hidden");
}

/* Close theme panel when clicking outside */
document.addEventListener("click", (e) => {
    const toggleBtn = document.querySelector("[data-theme-toggle]");
    if (!themePanel.classList.contains("hidden")) {
        if (!themePanel.contains(e.target) && !toggleBtn.contains(e.target)) {
            themePanel.classList.add("hidden");
        }
    }
});

/* ================= CHAT UI ================= */

function appendMessage(text, isUser) {
    const msgDiv = document.createElement('div');
    
    if (isUser) {
        msgDiv.className = "user-msg p-4 rounded-2xl self-end max-w-[80%] text-slate-100 font-medium shadow-sm";
    } else {
        msgDiv.className = "bg-slate-800/40 backdrop-blur-md border border-white/5 p-4 rounded-2xl self-start max-w-[80%] text-slate-300 shadow-sm";
    }

    // Convert newlines to <br> so lists and secrets format correctly
    msgDiv.innerHTML = text.replace(/\n/g, '<br>');
    
    container.appendChild(msgDiv);
    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
}

/* ================= MAIN CHAT LOGIC ================= */

async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    // 1. Add user message to UI
    appendMessage(text, true);
    input.value = '';

    // 2. Create and show typing indicator
    const typingId = "typing-" + Date.now();
    const typingDiv = document.createElement('div');
    typingDiv.id = typingId;
    typingDiv.className = "bg-slate-800/20 p-3 rounded-xl self-start text-cyan-400/80 text-xs animate-pulse italic";
    typingDiv.innerText = "KitCat is typing...";
    container.appendChild(typingDiv);
    container.scrollTop = container.scrollHeight;

    try {
        // 3. API Request to Flask
        const res = await fetch('/api/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message: text })
        });

        // Remove typing indicator
        const indicator = document.getElementById(typingId);
        if (indicator) indicator.remove();

        if (!res.ok) throw new Error("API Error");

        const data = await res.json();

        // 4. Handle Server-Side Theme Trigger (from Streak Logic)
        if (data.theme_trigger) {
            setTheme(data.theme_trigger);
        }

        // 5. Handle Manual Keyword Themes (Extra Fallback)
        const lower = text.toLowerCase();
        if (lower.includes("dark mode")) setTheme("dark");
        if (lower.includes("original theme")) setTheme("default");

        // 6. Display AI Response
        appendMessage(data.response, false);

    } catch (e) {
        // Remove indicator on error
        const indicator = document.getElementById(typingId);
        if (indicator) indicator.remove();
        
        console.error("Chat Error:", e);
        const errorDiv = document.createElement('div');
        errorDiv.className = "text-red-400 text-[10px] text-center uppercase tracking-widest mt-2";
        errorDiv.innerText = "KitCat had a glitch... try again ðŸ’«";
        container.appendChild(errorDiv);
    }
}

/* Listen for Enter Key */
input.addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessage();
});
</script>
</body>
</html>
